<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<title>IFTAR MAP</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:Arial;background:#f3f4f6;}

#ipBar{
  position:fixed;
  top:0;
  width:100%;
  text-align:center;
  background:#111;
  color:#fff;
  padding:4px;
  font-size:12px;
  z-index:2000;
}

#topBar{
  position:fixed;
  top:24px;
  width:100%;
  display:flex;
  align-items:center;
  gap:10px;
  padding:10px;
  background:#fff;
  z-index:2000;
  box-shadow:0 2px 6px rgba(0,0,0,.1);
}

#logo{
  font-weight:bold;
  color:#1e7e34;
  font-size:14px;
  white-space:nowrap;
}

#search{
  flex:1;
  padding:12px;
  border-radius:12px;
  border:1px solid #ccc;
  font-size:16px;
}

#map{
  position:absolute;
  top:80px;
  bottom:200px;
  width:100%;
  z-index:1;
}

#bottomSection{
  position:absolute;
  bottom:0;
  width:100%;
  height:200px;
  background:#f3f4f6;
  overflow-y:auto;
}

.greenBar{
  background:#1e7e34;
  color:#fff;
  padding:12px;
  font-weight:bold;
  display:flex;
  justify-content:space-between;
}

.card{
  background:#fff;
  margin:10px;
  padding:12px;
  border-radius:10px;
  box-shadow:0 2px 6px rgba(0,0,0,.08);
}

.vote button{
  margin-top:8px;
  margin-right:8px;
  padding:6px 10px;
  border:none;
  border-radius:6px;
  cursor:pointer;
}

.true{background:#28a745;color:#fff;}
.false{background:#dc3545;color:#fff;}
</style>
</head>

<body>

<div id="ipBar">Loading IP...</div>

<div id="topBar">
  <div id="logo">IFTAR MAP</div>
  <input id="search" placeholder="‡¶Æ‡¶∏‡¶ú‡¶ø‡¶¶ ‡¶¨‡¶æ ‡¶è‡¶≤‡¶æ‡¶ï‡¶æ ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®..." />
</div>

<div id="map"></div>

<div id="bottomSection">
  <div class="greenBar">
    <span>‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡ßü ‡¶≤‡ßã‡¶ï‡ßá‡¶∂‡¶®</span>
    <span id="count">0 ‡¶ü‡¶ø</span>
  </div>
  <div id="list"></div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
const map=L.map('map').setView([22.3569,91.7832],12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let markers=[];
let pressTimer;

/* ===== SHOW IP ===== */
fetch("https://api.ipify.org?format=json")
.then(res=>res.json())
.then(data=>{
  document.getElementById("ipBar").innerText="IP: "+data.ip;
});

/* ===== LOAD DATA ===== */
async function load(query=""){
  let url="/api/locations";
  if(query) url="/api/locations/search?q="+query;

  const res=await fetch(url);
  const data=await res.json();
  render(data);
}

/* ===== RENDER ===== */
function render(data){
  document.getElementById("list").innerHTML="";
  document.getElementById("count").innerText=data.length+" ‡¶ü‡¶ø";

  markers.forEach(m=>map.removeLayer(m));
  markers=[];

  data.forEach(loc=>{
    const marker=L.marker([loc.lat,loc.lng]).addTo(map);
    markers.push(marker);

    const div=document.createElement("div");
    div.className="card";
    div.innerHTML=`
      <b>${loc.name}</b><br/>
      üëç ${loc.trueVotes||0} |
      üëé ${loc.falseVotes||0}
      <div class="vote">
        <button class="true" onclick="vote('${loc._id}','true')">‡¶∏‡¶§‡ßç‡¶Ø‡¶ø</button>
        <button class="false" onclick="vote('${loc._id}','false')">‡¶≠‡ßÅ‡ßü‡¶æ</button>
      </div>
    `;
    document.getElementById("list").appendChild(div);
  });
}

/* ===== SEARCH ===== */
document.getElementById("search").addEventListener("input",function(){
  load(this.value);
});

/* ===== VOTE ===== */
async function vote(id,type){
  await fetch("/api/locations/vote/"+id,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({type})
  });
  load();
}

/* ===== LONG PRESS ===== */
map.on("mousedown",e=>{
  pressTimer=setTimeout(()=>{
    addPopup(e.latlng);
  },600);
});
map.on("mouseup",()=>clearTimeout(pressTimer));
map.on("mouseout",()=>clearTimeout(pressTimer));
map.on("touchstart",e=>{
  pressTimer=setTimeout(()=>{
    addPopup(e.latlng);
  },600);
});
map.on("touchend",()=>clearTimeout(pressTimer));

function addPopup(latlng){
  L.popup()
    .setLatLng(latlng)
    .setContent(`<button onclick="addLocation(${latlng.lat},${latlng.lng})">‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶≤‡ßã‡¶ï‡ßá‡¶∂‡¶® ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</button>`)
    .openOn(map);
}

async function addLocation(lat,lng){
  const name=prompt("‡¶≤‡ßã‡¶ï‡ßá‡¶∂‡¶®‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®:");
  if(!name) return;

  await fetch("/api/locations",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({name,lat,lng})
  });

  alert("Admin approval pending");
  load();
}

load();
</script>

</body>
</html>q
