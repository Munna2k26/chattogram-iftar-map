<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<title>Chattogram Iftar Map</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
body{margin:0;font-family:Arial;background:#f2f2f2;}
#map{height:65vh;}
#topbar{
  background:white;
  padding:10px;
  display:flex;
  gap:10px;
  box-shadow:0 2px 4px rgba(0,0,0,.1);
}
#search{
  flex:1;
  padding:8px;
  border-radius:6px;
  border:1px solid #ccc;
}
.green-bar{
  background:#1e7e34;
  color:white;
  padding:10px;
  font-weight:bold;
}
.card{
  background:white;
  margin:10px;
  padding:12px;
  border-radius:8px;
  box-shadow:0 2px 4px rgba(0,0,0,.1);
}
button{
  padding:6px 10px;
  border:none;
  border-radius:6px;
  cursor:pointer;
}
.true{background:#28a745;color:white;}
.false{background:#dc3545;color:white;}
.badge{
  background:#28a745;
  color:white;
  padding:3px 6px;
  border-radius:4px;
  font-size:12px;
  margin-left:6px;
}
</style>
</head>

<body>

<div id="topbar">
  <input id="search" placeholder="‡¶Æ‡¶∏‡¶ú‡¶ø‡¶¶ ‡¶¨‡¶æ ‡¶è‡¶≤‡¶æ‡¶ï‡¶æ ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®..."/>
</div>

<div id="map"></div>

<div class="green-bar">‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡ßü ‡¶≤‡ßã‡¶ï‡ßá‡¶∂‡¶®</div>
<div id="list"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
const map=L.map('map').setView([22.3569,91.7832],12);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png')
.addTo(map);

let markers=[];
let holdTimer=null;

/* ====== LOAD DATA ====== */
async function load(){
  const res=await fetch('/api/locations');
  const data=await res.json();

  document.getElementById('list').innerHTML='';
  markers.forEach(m=>map.removeLayer(m));
  markers=[];

  data.forEach(loc=>{
    const marker=L.marker([loc.lat,loc.lng])
    .addTo(map)
    .bindPopup(loc.name);
    markers.push(marker);

    const div=document.createElement('div');
    div.className='card';
    div.innerHTML=`
      <b>${loc.name}</b>
      ${loc.approved?'<span class="badge">Verified</span>':''}
      <div>üëç ${loc.trueVotes||0} üëé ${loc.falseVotes||0}</div>
      <button class="true" onclick="vote('${loc._id}','true')">‡¶∏‡¶§‡ßç‡¶Ø‡¶ø</button>
      <button class="false" onclick="vote('${loc._id}','false')">‡¶≠‡ßÅ‡ßü‡¶æ</button>
    `;
    document.getElementById('list').appendChild(div);
  });
}

/* ====== VOTE ====== */
async function vote(id,type){
  await fetch('/api/locations/vote/'+id,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({type})
  });
  load();
}

/* ====== LONG PRESS ADD ====== */
map.on('mousedown',function(e){
  holdTimer=setTimeout(()=>{
    const name=prompt("‡¶≤‡ßã‡¶ï‡ßá‡¶∂‡¶®‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®:");
    if(!name)return;

    fetch('/api/locations',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        name,
        lat:e.latlng.lat,
        lng:e.latlng.lng
      })
    }).then(()=>{
      alert("Admin approval pending");
      load();
    });
  },800); // 0.8 second hold
});

map.on('mouseup',function(){
  clearTimeout(holdTimer);
});

map.on('mouseout',function(){
  clearTimeout(holdTimer);
});

/* ====== SEARCH ====== */
document.getElementById('search')
.addEventListener('input',function(){
  const val=this.value.toLowerCase();
  document.querySelectorAll('.card').forEach(c=>{
    c.style.display=c.innerText.toLowerCase().includes(val)
    ?'block':'none';
  });
});

load();
</script>

</body>
</html>
