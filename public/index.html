<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<title>Chattogram Iftar Map</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
body{margin:0;font-family:Arial;background:#f3f4f6;}
#ipBar{text-align:center;padding:6px;background:#111;color:#fff;font-size:13px;}
#header{background:#fff;padding:10px;display:flex;align-items:center;gap:15px;box-shadow:0 2px 4px rgba(0,0,0,.1);}
#logo{font-size:14px;font-weight:bold;color:#1e7e34;}
#search{flex:1;padding:10px;border-radius:8px;border:1px solid #ccc;font-size:16px;}
#map{height:60vh;}
.green-bar{background:#1e7e34;color:#fff;padding:12px;font-weight:bold;display:flex;justify-content:space-between;}
.card{background:#fff;margin:12px;padding:12px;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,.08);}
.card-top{display:flex;justify-content:space-between;}
.badge{background:#28a745;color:#fff;padding:3px 6px;border-radius:6px;font-size:12px;}
.vote{margin-top:8px;display:flex;gap:10px;}
.vote button{padding:6px 10px;border:none;border-radius:6px;cursor:pointer;}
.true{background:#28a745;color:#fff;}
.false{background:#dc3545;color:#fff;}
</style>
</head>

<body>

<div id="ipBar">Loading IP...</div>

<div id="header">
  <div id="logo">IFTAR MAP</div>
  <input id="search" placeholder="‡¶Æ‡¶∏‡¶ú‡¶ø‡¶¶ ‡¶¨‡¶æ ‡¶è‡¶≤‡¶æ‡¶ï‡¶æ ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®..." />
</div>

<div id="map"></div>

<div class="green-bar">
  <span>‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡ßü ‡¶≤‡ßã‡¶ï‡ßá‡¶∂‡¶®</span>
  <span id="count">0 ‡¶ü‡¶ø</span>
</div>

<div id="list"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
const map=L.map('map').setView([22.3569,91.7832],12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let markers=[];
let pressTimer;

/* ===== IP ===== */
fetch("https://api.ipify.org?format=json")
.then(res=>res.json())
.then(data=>{
  document.getElementById("ipBar").innerText="Your IP: "+data.ip;
});

/* ===== LOAD ===== */
async function load(query=""){
  let url='/api/locations';
  if(query) url='/api/locations/search?q='+query;

  const res=await fetch(url);
  const data=await res.json();

  render(data);
}

/* ===== RENDER ===== */
function render(data){
  document.getElementById('list').innerHTML='';
  document.getElementById('count').innerText=data.length+" ‡¶ü‡¶ø";

  markers.forEach(m=>map.removeLayer(m));
  markers=[];

  data.forEach(loc=>{
    const marker=L.marker([loc.lat,loc.lng]).addTo(map);
    markers.push(marker);

    const div=document.createElement('div');
    div.className='card';
    div.innerHTML=`
      <div class="card-top">
        <b>${loc.name}</b>
        ${loc.approved?'<span class="badge">Verified</span>':''}
      </div>
      <div class="vote">
        <button class="true" onclick="vote('${loc._id}','true')">
          üëç ${loc.trueVotes||0}
        </button>
        <button class="false" onclick="vote('${loc._id}','false')">
          üëé ${loc.falseVotes||0}
        </button>
      </div>
    `;
    document.getElementById('list').appendChild(div);
  });
}

/* ===== SEARCH ===== */
document.getElementById('search').addEventListener('focus',()=>map.dragging.disable());
document.getElementById('search').addEventListener('blur',()=>map.dragging.enable());
document.getElementById('search').addEventListener('input',function(){
  load(this.value);
});

/* ===== VOTE ===== */
async function vote(id,type){
  await fetch('/api/locations/vote/'+id,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({type})
  });
  load();
}

/* ===== LONG PRESS ADD ===== */
map.on('mousedown',startPress);
map.on('mouseup',cancelPress);
map.on('mouseout',cancelPress);
map.on('touchstart',startPress);
map.on('touchend',cancelPress);

function startPress(e){
  pressTimer=setTimeout(()=>{
    showAdd(e.latlng);
  },600);
}

function cancelPress(){
  clearTimeout(pressTimer);
}

function showAdd(latlng){
  L.popup()
    .setLatLng(latlng)
    .setContent(`
      <button onclick="addLocation(${latlng.lat},${latlng.lng})">
      ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶≤‡ßã‡¶ï‡ßá‡¶∂‡¶® ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®
      </button>
    `)
    .openOn(map);
}

async function addLocation(lat,lng){
  const name=prompt("‡¶≤‡ßã‡¶ï‡ßá‡¶∂‡¶®‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®:");
  if(!name) return;

  await fetch('/api/locations',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({name,lat,lng})
  });

  alert("Admin approval pending");
  load();
}

load();
</script>

</body>
</html>
